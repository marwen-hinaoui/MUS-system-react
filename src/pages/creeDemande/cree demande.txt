import { useState, useEffect } from "react";
import {
  Input,
  Select,
  Form,
  Table,
  notification,
  Breadcrumb,
  Tooltip,
  Empty,
  InputNumber,
  Col,
  Row,
  Button,
  Alert,
} from "antd";
import CardComponent from "../../components/card/cardComponent";
import {
  openNotification,
  openNotificationSuccess,
} from "../../components/notificationComponent/openNotification";
import { RiDashboardHorizontalLine } from "react-icons/ri";
import { Link } from "react-router-dom";
import { MdDelete } from "react-icons/md";
import { COLORS } from "../../constant/colors";
import { FONTSIZE, ICONSIZE } from "../../constant/FontSizes";
import SharedButton from "../../components/button/button";
import { get_project } from "../../api/get_project";
import { get_sites } from "../../api/get_sites";
import { get_lieuDetection } from "../../api/get_lieuDetection";
import { create_demande_api } from "../../api/create_demande_api";
import { useDispatch, useSelector } from "react-redux";
import { set_loading } from "../../redux/slices";
import LoadingComponent from "../../components/loadingComponent/loadingComponent";

const { Option } = Select;
const breadcrumb = [
  {
    title: <RiDashboardHorizontalLine />,
  },

  {
    title: <Link to={"/admin"}>Dashboard</Link>,
  },
  {
    title: "Creation demande",
  },
];
const CreeDemande = () => {
  const [data, setData] = useState([]);
  const [projects, setProjetcs] = useState([]);
  const [sites, setSites] = useState([]);
  const [lieuDetection, setLieuDetection] = useState([]);
  const [sequence, setSequence] = useState("");
  const [responseMsg, setResponseMsg] = useState("");
  const [sequenceValid, setSequenceValid] = useState(false);
  const [subDemandes, setSubDemandes] = useState([]);
  const [api, contextHolder] = notification.useNotification();
  const dispatch = useDispatch();
  const [demande, setDemande] = useState({});
  const token = useSelector((state) => state.app.tokenValue);
  const id_userMUS = useSelector((state) => state.app.userId);
  const isLoading = useSelector((state) => state.app.isLoading);

  const fetchData = async () => {
    try {
      const res = await fetch("/cms.json");
      const json = await res.json();
      setData(json);

      const resProjet = await get_project();
      setProjetcs(resProjet.resData.data);

      const resSites = await get_sites();
      setSites(resSites.resData.data);
    } catch (err) {
      console.error("Failed to fetch:", err);
    }
  };
  useEffect(() => {
    fetchData();
    fetchTrim();
  }, []);

  const fetchTrim = async () => {
    const resProjet = await get_project();
    setProjetcs(resProjet.resData.data);

    const resSites = await get_sites();
    setSites(resSites.resData.data);

    const resLieu = await get_lieuDetection();
    setLieuDetection(resLieu.resData.data);
  };

  if (
    data.length === 0 ||
    projects.length === 0 ||
    sites.length === 0 ||
    lieuDetection.length === 0
  )
    return <LoadingComponent header={true} />;
  // validate sequence
  const handleSequenceChange = (val) => {
    setSequence(val);
    if (/^\d{12}$/.test(val)) {
      const exists = data?.CMS.some((c) => c.sequence === val);
      setSequenceValid(exists);
      if (exists) {
        setSubDemandes([
          {
            key: Date.now(),
            partNumber: "",
            patternNumb: "",
            materialPartNumber: "",
            quantite: "",
          },
        ]);
      } else if (val.length === 12) {
        setSubDemandes([]);
      }
    } else {
      setSequenceValid(false);
      setSubDemandes([]);
    }
  };

  if (!Array.isArray(data?.CMS)) return [];
  const partNumbers =
    data.CMS.find((c) => c.sequence === sequence)?.partNumbers || [];

  const materialsMap = data?.Materials[0];

  const handleAddRow = () => {
    setSubDemandes((prev) => [
      ...prev,
      {
        key: Date.now(),
        partNumber: "",
        patternNumb: "",
        quantite: "",
      },
    ]);
  };

  // Update row ---------------------------------------------------------------
  const handleChange = (key, field, value) => {
    setSubDemandes((prev) =>
      prev.map((row) => {
        if (row.key !== key) return row;

        const updatedRow = { ...row };

        if (field === "defaut") {
          updatedRow.code_defaut = value.code_defaut;
          updatedRow.typeDefaut = value.typeDefaut;
        } else {
          updatedRow[field] = value;
        }

        if (field === "patternNumb") {
          const partObj = partNumbers.find(
            (p) => p.partNumber === updatedRow.partNumber
          );
          const partMaterials = partObj?.materials || [];
          const matchedMaterial =
            partMaterials.find((mat) =>
              materialsMap[mat]?.includes(Number(value))
            ) || "";
          updatedRow.materialPartNumber = matchedMaterial;
        }

        return updatedRow;
      })
    );
  };

  // Delete row ---------------------------------------------------------------

  const handleDelete = (key) => {
    setSubDemandes((prev) => prev.filter((row) => row.key !== key));
  };

  const columns = [
    {
      title: "Part number",

      dataIndex: "partNumber",
      key: "partNumber",
      render: (text, record) => (
        <Select
          value={record.partNumber || undefined}
          placeholder="Select Part number"
          onChange={(val) => handleChange(record.key, "partNumber", val)}
          showSearch
          optionFilterProp="children"
          style={{ width: "100%", height: "34px" }}
        >
          {partNumbers.map((p) => (
            <Option key={p.partNumber} value={p.partNumber}>
              {p.partNumber}
            </Option>
          ))}
        </Select>
      ),
    },

    {
      title: "Pattern",
      dataIndex: "patternNumb",
      key: "patternNumb",
      render: (text, record) => {
        const partObj = partNumbers.find(
          (p) => p.partNumber === record.partNumber
        );
        const partMaterials = partObj?.materials || [];
        let availablePatterns = [];
        partMaterials.forEach((mat) => {
          if (materialsMap[mat])
            availablePatterns = [...availablePatterns, ...materialsMap[mat]];
        });

        return (
          <Select
            value={record.patternNumb || undefined}
            placeholder="Select Pattern"
            onChange={(val) => handleChange(record.key, "patternNumb", val)}
            disabled={!record.partNumber}
            showSearch
            optionFilterProp="children"
            style={{ width: "100%", height: "34px" }}
          >
            {availablePatterns.map((pat, i) => (
              <Option key={i} value={pat}>
                {pat}
              </Option>
            ))}
          </Select>
        );
      },
    },
    {
      title: "Material",
      dataIndex: "materialPartNumber",
      key: "materialPartNumber",
      render: (text, record) => (
        <Input
          style={{ width: "100%", height: "34px" }}
          value={record.materialPartNumber}
          readOnly
        />
      ),
    },
    {
      title: "Defaut",
      dataIndex: "defaut",
      key: "defaut",
      render: (text, record) => (
        <Select
          value={record.code_defaut || undefined}
          placeholder="Select defaut"
          onChange={(val, option) =>
            handleChange(record.key, "defaut", {
              code_defaut: val,
              typeDefaut: option.typeDefaut,
            })
          }
          showSearch
          optionFilterProp="children"
          style={{ width: "100%", height: "34px" }}
        >
          {data.DefautCMS.map((def) => (
            <Option
              key={def.code_defaut}
              value={def.code_defaut}
              typeDefaut={def.typeDefaut}
            >
              {`${def.code_defaut} (${def.typeDefaut})`}
            </Option>
          ))}
        </Select>
      ),
    },
    {
      title: "Quantité",
      dataIndex: "quantite",
      key: "quantite",
      render: (text, record) => (
        <InputNumber
          min={1}
          max={999}
          // style={{ padding: "3px" }}
          style={{ width: "100%", height: "34px" }}
          onChange={(val) => handleChange(record.key, "quantite", val)}
          value={record.quantite}
        />
      ),
    },
    {
      title: "Action",
      dataIndex: "action",
      key: "action",
      width: 80,
      align: "center",
      render: (_, record, index) => {
        const onlyOneRow = subDemandes.length === 1;
        return (
          // <Tooltip title="Supprimer sub demande">
          <MdDelete
            style={{
              cursor: "pointer",
            }}
            color={COLORS.LearRed}
            size={ICONSIZE.SMALL}
            onClick={() => handleDelete(record.key)}
            disabled={onlyOneRow}
          />
          // </Tooltip>
          // </Button>
        );
      },
    },
  ];

  const handleSelectChange = (field, value) => {
    setDemande((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  const onSubmit = async () => {
    if (!sequenceValid) {
      // openNotification(api, "Sequance incorrect!");
      return;
    }

    if (
      subDemandes.some(
        (row) =>
          !row.partNumber ||
          !row.patternNumb ||
          !row.materialPartNumber ||
          !row.code_defaut ||
          !row.quantite
      )
    ) {
      openNotification(
        api,
        "Veillez saisie Part number, pattern, defaut, quantite"
      );
      return;
    }
    const cleanSubDemandes = subDemandes.map(({ key, ...rest }) => rest);
    const demandeToSubmit = {
      id_userMUS: id_userMUS,
      id_site: demande.id_site,
      id_projet: demande.id_projet,
      id_lieuDetection: demande.id_lieuDetection,
      sequence: sequence,
      subDemandes: cleanSubDemandes,
    };

    console.log(subDemandes);
    console.log(demandeToSubmit);

    if (token) {
      dispatch(set_loading(true));
      const resDemande = await create_demande_api(demandeToSubmit, token);
      console.log(resDemande);
      if (resDemande.resData) {
        if (resDemande.resData.data.statusDemande) {
          // openNotification(api, resDemande.resData.message);
          setResponseMsg(resDemande.resData.message);
        } else {
          // openNotificationSuccess(api, resDemande.resData.message);
          setResponseMsg(resDemande.resData.message);
        }
      } else {
        openNotification(api, resDemande.resError.message);
      }
      dispatch(set_loading(false));
      setSequence("");
      setSequenceValid(false);
      setSubDemandes([]);
    }
  };

  return (
    <div className="dashboard">
      {contextHolder}
      <div style={{ paddingBottom: "13px" }}>
        <Breadcrumb
          style={{ fontSize: FONTSIZE.XPRIMARY }}
          items={breadcrumb}
        />
      </div>
      {responseMsg !== "" && (
        <div style={{ paddingBottom: "13px" }}>
          <Alert message={responseMsg} type="success" showIcon closable />
        </div>
      )}
      <Form layout="vertical" onFinish={onSubmit}>
        {/* <CardComponent padding={"10px"} margin={"0 0 10px 0"}> */}
        <CardComponent padding={"7px"}>
          <Row gutter={24}>
            <Col xs={24} sm={12} md={6}>
              <Form.Item
                label="Sequence"
                name="sequence"
                rules={[
                  { required: true, message: "Sequence is required!" },
                  { len: 12, message: "Sequence must be 12 digits!" },
                  {
                    validator: (_, value) =>
                      data?.CMS.some((c) => c.sequence === value)
                        ? Promise.resolve()
                        : Promise.reject("Sequence not found in CMS"),
                  },
                ]}
              >
                <Input
                  style={{ height: "34px" }}
                  value={sequence}
                  onChange={(e) => handleSequenceChange(e.target.value)}
                  maxLength={12}
                />
              </Form.Item>
            </Col>
            <Col xs={24} sm={12} md={6}>
              <Form.Item label="Site">
                <Select
                  style={{ height: "34px" }}
                  value={demande.id_site}
                  placeholder="Select site"
                  onChange={(val) => handleSelectChange("id_site", val)}
                  showSearch
                  optionFilterProp="children"
                >
                  {sites.map((rec) => (
                    <Option key={rec.id} value={rec.id}>
                      {rec.nom}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
            <Col xs={24} sm={12} md={6}>
              <Form.Item label="Projet">
                <Select
                  style={{ height: "34px" }}
                  placeholder="Select projet"
                  value={demande.id_projet}
                  onChange={(val) => handleSelectChange("id_projet", val)}
                  showSearch
                  optionFilterProp="children"
                >
                  {projects.map((rec) => (
                    <Option key={rec.id} value={rec.id}>
                      {rec.nom}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
            <Col xs={24} sm={12} md={6}>
              <Form.Item label="Lieu detection">
                <Select
                  style={{ height: "34px" }}
                  placeholder="Lieu detection"
                  value={demande.id_lieuDetection}
                  onChange={(val) =>
                    handleSelectChange("id_lieuDetection", val)
                  }
                  showSearch
                  optionFilterProp="children"
                >
                  {lieuDetection.map((rec) => (
                    <Option key={rec.id} value={rec.id}>
                      {rec.nom}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
          </Row>
        </CardComponent>
        {/* <Button onClick={handleAddRow} danger> */}
        <div
          style={{
            padding: "17px 0",
            display: "flex",
            justifyContent: "start",
          }}
        >
          <Button onClick={handleAddRow} color="danger" variant="outlined">
            <p style={{}}>Ajout sub demande</p>
          </Button>
        </div>

        {/* {sequenceValid && ( */}

        <div
        // style={{
        //   paddingTop: "17px",
        // }}
        >
          <CardComponent>
            <Table
              rowClassName={() => "ant-row-no-hover"}
              bordered
              dataSource={subDemandes}
              columns={columns}
              pagination={false}
              rowKey="key"
              size="small"
              locale={{
                emptyText: (
                  <Empty
                    description="Aucune donnée trouvée"
                    image={Empty.PRESENTED_IMAGE_SIMPLE}
                  />
                ),
              }}
            />
          </CardComponent>
        </div>
        <div
          style={{
            display: "flex",
            justifyContent: "flex-end",
            paddingTop: "17px",
            paddingBottom: "17px",
          }}
        >
          <div style={{ paddingRight: "10px" }}></div>
          <Form.Item>
            <SharedButton
              loading={isLoading}
              // padding={"17px 11px"}
              type="primary"
              // color={COLORS.LearRed}
              name={"Enregistrer"}
              color={COLORS.LearRed}
              // disabled={!sequenceValid || subDemandes.length === 0}
            />
          </Form.Item>
        </div>
      </Form>
    </div>
  );
};

export default CreeDemande;
